# Contributing to cfgate Helm Chart

## Chart-Project Synchronization

The Helm chart sources are derived from the [cfgate controller](https://github.com/cfgate/cfgate). When upstream sources change, the chart must be updated manually.

### Source Dependencies

| Chart File | Upstream Source | Sync Trigger |
|------------|-----------------|--------------|
| `templates/crds/*.yaml` | `config/crd/bases/*.yaml` | CRD schema changes |
| `templates/clusterrole.yaml` | `config/rbac/role.yaml` | RBAC rule changes |
| `templates/deployment.yaml` | `config/manager/manager.yaml` | Container args, ports, probes |
| `values.yaml` | `cmd/manager/main.go` | New flags, defaults |
| `templates/NOTES.txt` | Project docs, CRD names | New features, workflow changes |

### Regenerating CRDs

CRDs in `templates/crds/` are templated versions of the generated CRDs.

1. Generate fresh CRDs in the controller repo:
   ```bash
   cd ../cfgate
   mise run codegen
   ```

2. For each CRD in `config/crd/bases/cfgate.io_*.yaml`:
   - Copy the CRD content
   - Wrap with Helm conditional:
     ```yaml
     {{- if .Values.installCRDs }}
     # CRD content here
     {{- end }}
     ```
   - Add annotation under `metadata.annotations`:
     ```yaml
     "helm.sh/resource-policy": keep
     ```
   - Add labels block:
     ```yaml
     labels:
       {{- include "cfgate.labels" . | nindent 4 }}
     ```

3. Write to `templates/crds/{resource-name}.yaml`

### Regenerating RBAC

The ClusterRole is generated by controller-gen from kubebuilder markers.

1. Generate fresh RBAC in the controller repo:
   ```bash
   cd ../cfgate
   mise run codegen
   ```

2. Compare `config/rbac/role.yaml` with `templates/clusterrole.yaml`

3. Update the `rules:` section, preserving Helm templating wrapper

### Updating Deployment

When `config/manager/manager.yaml` changes:

1. Compare container args, ports, probes, security context
2. Update `templates/deployment.yaml` accordingly
3. Update `values.yaml` if new configurable options added

### Updating NOTES.txt

`templates/NOTES.txt` displays post-install instructions. Update when:

- New CRDs added or removed
- CLI flags or configuration options change
- Quick start workflow changes
- Documentation URLs change

Review periodically to ensure:
- Commands reflect current kubectl/helm usage
- CRD names match actual resources
- Links to documentation are valid

### Validation

After any sync:

```bash
helm lint .
helm template cfgate .
helm template cfgate . --set installCRDs=false
helm template cfgate . --set rbac.create=false
```

### Version Bumping

| Change Type | Bump |
|-------------|------|
| CRD schema change | Chart MINOR or MAJOR |
| New values.yaml option | Chart MINOR |
| Bug fix, docs | Chart PATCH |
| App version change | Update `appVersion` |

Update `Chart.yaml`:
- `version`: Chart version (independent of app)
- `appVersion`: cfgate release version

### CI Integration

Chart changes should pass:
- `helm lint`
- `helm template` with default values
- `helm template` with `ci/default-values.yaml`
