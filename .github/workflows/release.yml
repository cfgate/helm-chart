name: Release

on:
  push:
    tags:
      - "v*"

env:
  REGISTRY: ghcr.io

jobs:
  release:
    runs-on: blacksmith-4vcpu-ubuntu-2404
    timeout-minutes: 15
    permissions:
      contents: write
      packages: write

    steps:
      - uses: actions/checkout@v6

      - id: channel
        run: |
          VERSION="${GITHUB_REF_NAME#v}"
          if [[ "$VERSION" == *"-alpha."* || "$VERSION" == *"-beta."* || "$VERSION" == *"-rc."* ]]; then
            echo "prerelease=true" >> $GITHUB_OUTPUT
          else
            echo "prerelease=false" >> $GITHUB_OUTPUT
          fi

      - name: Patch prerelease annotation
        run: |
          sed -i "s|artifacthub.io/prerelease:.*|artifacthub.io/prerelease: \"${{ steps.channel.outputs.prerelease }}\"|" Chart.yaml

      - uses: azure/setup-helm@v4.3.1
        with:
          version: v4.1.0

      - name: Lint chart
        run: helm lint .

      - name: Package chart
        run: helm package . -d dist/

      - name: Push chart to GHCR
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" | helm registry login ghcr.io -u ${{ github.actor }} --password-stdin
          helm push dist/cfgate-*.tgz oci://ghcr.io/cfgate/charts

      - uses: softprops/action-gh-release@v2
        with:
          files: dist/cfgate-*.tgz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - uses: oras-project/setup-oras@v1

      - name: Push Artifact Hub metadata
        run: |
          echo "${{ secrets.GITHUB_TOKEN }}" | oras login ghcr.io -u ${{ github.actor }} --password-stdin
          oras push ${{ env.REGISTRY }}/cfgate/charts/cfgate:artifacthub.io \
            --config /dev/null:application/vnd.cncf.artifacthub.config.v1+yaml \
            artifacthub-repo.yml:application/vnd.cncf.artifacthub.repository-metadata.layer.v1.yaml
